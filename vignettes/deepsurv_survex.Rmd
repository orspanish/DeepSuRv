---
title: "deepsurv_survex"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{deepsurv_survex}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
```

```{r setup}
library(DeepSuRv)
library(torch)
library(survival)
library(survex)
```

# Lung data from survival package
```{r}
# Prepare data
lung_prep <- prep_data(lung, 'time', 'status')
X <- lung_prep$X_mat
dat <- lung_prep$dat
#requires manual status encoding to ensure correct event assignment
dat$status <- ifelse(dat$status == 2, 0, 1)

train_data <- list(
  x = torch_tensor(as.matrix(X), dtype = torch_float()),
  time = torch_tensor(dat$time, dtype = torch_float()),
  event = torch_tensor(dat$status, dtype = torch_float())
)

# Order by descending time
order_idx <- order(as.numeric(train_data$time), decreasing = TRUE)
train_data$x <- train_data$x[order_idx, ]
train_data$time <- train_data$time[order_idx]
train_data$event <- train_data$event[order_idx]

# Initialize model
model <- DeepSuRv$new(
  n_in = ncol(X),
  hidden_layers = c(16),
  dropout = 0,
  learning_rate = 0.01
)

model$set_standardization(X)

# Train
model$train(
  X_train = train_data$x,
  t_train = train_data$time,
  e_train = train_data$event
)

# Predict
risk_scores <- model$predict_risk(X)
head(risk_scores)
```

Create explainer function for DeepSurv model
```{r}
explainer <- make_deepsurv_explainer(model, dat, 'time', 'status')
```

Generate model profile and feature importance plot
```{r}
head(model_profile(explainer, output_type = "survival", variables = c("age", "sex")))

plot(model_parts(explainer))
```

# Veteran data from survival package
```{r}
#Preprocess data
veteran_prep <- prep_data(veteran, 'time', 'status')
X <- veteran_prep$X_mat
dat <- veteran_prep$dat

train_data <- list(
  x = torch_tensor(as.matrix(X), dtype = torch_float()),
  time = torch_tensor(dat$time, dtype = torch_float()),
  event = torch_tensor(dat$status, dtype = torch_float())
)

# Order by descending time
order_idx <- order(as.numeric(train_data$time), decreasing = TRUE)
train_data$x <- train_data$x[order_idx, ]
train_data$time <- train_data$time[order_idx]
train_data$event <- train_data$event[order_idx]

# Initialize model
model <- DeepSuRv$new(
  n_in = ncol(X),
  hidden_layers = c(16),
  dropout = 0,
  learning_rate = 0.01
)

# Standardize inputs
model$set_standardization(X)

# Train
model$train(
  X_train = train_data$x,
  t_train = train_data$time,
  e_train = train_data$event
)

# Predict
risk_scores <- model$predict_risk(X)
head(risk_scores)

model$sigma

# Create explainer
explainer <- make_deepsurv_explainer(model, dat, 'time', 'status')

# Survex integration
model_profile(explainer, output_type = "survival", variables = c("trt", "age"))
plot(model_parts(explainer))
```

